@(username: String)

@main("MemoryWatch") {
    @header("demo")
    <div class="container">
        <div class="page-header">
            <div><h1>MemoryWatch <span class="glyphicon glyphicon-comment"></span></h1></div>
            <div class="pull-right"><span class="glyphicon glyphicon-user"></span><span id="user-count"></span></div>
            <div class="clearfix"></div>
        </div>
        <div class="row">
            <div class="col-sm-4">
                <div class="chat-wrapper">
                    <div id="onError" class="alert-message error">
                        <p><strong>Oops!</strong><span></span></p>
                    </div>
                    <div id="onChat">
                        <div class="chat-inner-wrapper">
                            <div id="messages"></div>
                            <input type="text" id="talk" placeholder="여기에 글을 입력하세요" autofocus="on"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-8">
                <pre id="message">
                </pre>
                <pre id="response">
                </pre>
            </div>
        </div>
    </div>

    <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
        $('#messages').slimscroll({
            color: 'darkorange',
            size: '6px',
            width: '100%',
            height: '360px'
        });

        var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket
        var chatSocket = new WS("@routes.Chat.chat(username).webSocketURL(request)")

        var sendMessage = function() {
            if($("#talk").val().length > 0) {
                chatSocket.send(JSON.stringify(
                    {text: $("#talk").val()}
                ))
                $("#talk").val('')
            }
        }

        var receiveEvent = function(event) {
            var data = JSON.parse(event.data)

            // Handle errors
            if(data.error) {
                chatSocket.close()
                $("#onError span").text(data.error)
                $("#onError").show()
                return
            } else {
                $("#onChat").show()
            }

            if (data.kind == 'response') {
                console.log(data);
                $("#response" ).text(JSON.stringify(data,null,"\t"));
            }
            else {
                $("#message" ).text(JSON.stringify(data,null,"\t"));

                var el = $('<div class="message"><span></span><p></p></div>')
                $("span", el).text(data.user)
                $("p", el).text(data.message)
                $(el).addClass(data.kind)
                if(data.user == '@username') $(el).addClass('me')
                $('#messages').append(el)
            }

            // Update the members list
            $("#members").html('')
            $(data.members).each(function() {
                $("#user-count" ).text(data.members.length)
                $("#members").append('<li>' + this + '</li>')
            })

        var totalHeight = 0;
        $('div#messages div').each(function() {
            totalHeight = totalHeight + $(this).height()+12;
        })
        $('#messages').slimScroll({ scrollTo: totalHeight});
        }

        var handleReturnKey = function(e) {
            if(e.charCode == 13 || e.keyCode == 13) {
                e.preventDefault()
                sendMessage()
            }
        }

        $("#talk").keypress(handleReturnKey)

        chatSocket.onmessage = receiveEvent
    })
    </script>

}